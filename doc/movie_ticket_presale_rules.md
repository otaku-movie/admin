# 影院票务逻辑精简版

## 一、核心模型

| 概念 | 说明 |
|------|------|
| **规则 (Rule)** | 定价的最小单位，定义适用人群及对应票价、匹配优先级。 |
| **活动 (Activity)** | 规则的容器，通过组合多条规则实现复杂定价策略；可配置是否支持前售券类抵扣。 |
| **场次 (Showtime)** | 执行单元，关联活动并设定规格补价（如 IMAX/3D 加价）。 |

## 二、定价计算公式

**最终总价 = 基础票价 (Base) + 规格补价 (Surcharge)**

| 模式/手段 | 基础票价计算方式 | 规格补价 |
|-----------|------------------|----------|
| **100% 抵扣券 (Muviticket/前售券)** | 强制为 0 | 原样叠加 |
| **固定金额抵扣券** | Max(0, 规则价 - 券面值) | 原样叠加 |
| **固定价格模式** | 取场次设定的 fixed_amount | 原样叠加 |
| **系统活动模式** | 在关联活动中，匹配符合用户身份且优先级最高的一条规则，取该规则的 value | 原样叠加 |

规格补价由场次配置（3D/IMAX 等）决定，始终原样叠加。

## 三、核心字段映射

| 实体 | 关键字段 | 说明 |
|------|----------|------|
| **Rule (规则)** | audience_type, value, priority | 适用人群、票价、匹配优先级（数值越小越优先） |
| **Activity (活动)** | rule_ids[] → pricing_rule 表, allow_muviticket | 包含的规则、是否支持前售券类抵扣 |
| **Showtime (场次)** | pricing_mode, activity_id, fixed_amount, surcharge | 定价模式、关联活动、固定价金额、规格补价 |

- **pricing_mode**: 1=系统活动模式 2=固定价格模式（使用 fixed_amount）
- **activity_id**: 关联 promotion 表（活动）
- **surcharge**: 场次级规格补价（可来自 3D + IMAX 等配置的汇总）

## 四、匹配逻辑说明

1. **人群校验在规则层**：仅当规则的 audience_type 与当前购票人身份一致时，该规则才进入候选（如「学生」身份只匹配学生规则）。
2. **优先级决策**：若多条规则同时满足（如既是「会员」又是「学生」），取 priority 数值**最小**的一条。
3. **支付与规格隔离**：
   - 全额抵扣、固定金额抵扣仅作用于**基础票价**；
   - **规格补价**（IMAX/3D 等差价）需按场次配置另行支付。

## 五、典型场景配置

### 金额券使用示例

- 用户持 1000 円券观看 1900 円 IMAX 场次（规格补价 1000 円）。
- 计算：基础 = Max(0, 1900 - 1000) = 900，总价 = 900 + 1000 = **1900 円**。

### Muviticket 使用示例

- 用户使用前售券观看同一 IMAX 场次。
- 计算：基础 = 0，总价 = 0 + 1000 = **1000 円**。

## 六、数据库与代码映射

- **pricing_rule**：规则表，promotion_id(活动)、audience_type、value、priority。
- **promotion**：活动表，增加 allow_muviticket。
- **movie_show_time**：场次表，增加 pricing_mode、activity_id、fixed_amount、surcharge。
- **TicketPriceService**：按 pricing_mode 与是否使用前售券/金额券计算基础价，再加 surcharge 得到最终总价。
